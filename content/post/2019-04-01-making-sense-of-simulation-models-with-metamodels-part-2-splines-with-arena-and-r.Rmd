---
title: Making Sense of Simulation Models with Metamodels Part 2 - Splines with Arena
  and R
author: Pedro N. de Lima
date: '2019-04-01'
slug: making-sense-of-simulation-models-with-metamodels-part-2-splines-with-arena-and-r
categories:
  - R Blogs
  - R
tags:
  - Arena Simualtion
  - Arena2R
  - Discrete Event Simulation
  - Metamodeling
  - R
header:
  caption: ''
  image: ''
---

In my [last post](post/making-sense-of-models-with-metamodels-low-order-polynomialss-with-arena-and-r/), I used low-order [polynomial regression](https://en.wikipedia.org/wiki/Polynomial_regression) to make sense of non-linear simulation model results. In this post, I'll demonstrate how you can use [splines](https://en.wikipedia.org/wiki/Spline_(mathematics)) to summarise results from an [Arena](https://www.arenasimulation.com/) simulation model. 

### Why Splines?

In the [previous post](post/making-sense-of-models-with-metamodels-low-order-polynomialss-with-arena-and-r/), I briefly described the motivation for using metamodels to approximate simulation models results. Splines are among the useful techinques for metamodeling because: (i) they are relatively simple (they are piecewise-defined polynomials); (ii) Unlike low-order polynomials, you can generally use them with a global sampling strategy [@Barton2006].

### Data Wrangling

Before developing our metamodel, let's first load the simulation data and do some data wrangling. For the details on this step, please refer to my [previous post](post/making-sense-of-models-with-metamodels-low-order-polynomialss-with-arena-and-r/).

```{r}
library(arena2r)
library(dplyr)
library(ggplot2)
library(readr)

sim_results = arena2r::get_simulation_results(source = "2019-03-metamodeling/")

sim_results$BatchSize = readr::parse_number(as.character(sim_results$Scenario))

sim_results = subset(sim_results, Statistic == "Entity 1.NumberOut")

head(sim_results)

```


### Trying Splines

The function bs from the splines package can be used for creating a b-spline term in our regression model.


```{r splines}
## Now using Splines:

library(splines)

# Building a Spline Model:

spline_model <-lm(Value ~ bs(BatchSize),data = sim_results)

summary(spline_model)

```

Does it make sense?

```{r}
# Does it make sense ?

ggplot(sim_results, mapping = aes(x = BatchSize, y = Value)) + 
  geom_point() + 
  stat_smooth(method = lm, formula = y ~ splines::bs(x))

```


### "Optimizing" with Splines

Now that we found a curve that can approximate our model results, we will use this model to find an "optimal" Batch Size which maximizes our Output Variable.


```{r}
## Defining limits:
batchlims <- range(sim_results$BatchSize)

# Generating Test Data
batch.grid<-seq(from=batchlims[1], to = batchlims[2])

# Using the metamodel:
spline_data = data.frame(BatchSize = batch.grid, 
                         Value = predict(spline_model,
                                         newdata = list(BatchSize=batch.grid))
                         )

# What is the Batch Size which "optimizes" the Output?
Optimum_BatchSize <- spline_data$BatchSize[which.max(spline_data$Value)]

Output_Value = spline_data$Value[which.max(spline_data$Value)]


```

Does it make sense?

```{r}

# Let's plot again with the optimum batch size:
ggplot(sim_results, mapping = aes(x = BatchSize, y = Value)) + 
  geom_point() + 
  stat_smooth(method = lm, formula = y ~ splines::bs(x)) +
  geom_vline(xintercept = Optimum_BatchSize) + 
  geom_text(aes(x=Optimum_BatchSize, label="\nOptimum Batch Size", y=9700), angle=90, text=element_text(size=11)) + 
  labs(y = "Output")


```

In this post, I covered how to apply splines to summarise results from a discrete event simulation model. Splines are a straightforward option to interpolate results from a simulation model, but there are other options out there. Future posts might explore other alternatives such as kriging metamodels and neural nets.


# References


