---
title: Making Sense of Simulation Models with Metamodels Part 2 - Splines with Arena
  and R
author: Pedro N. de Lima
date: '2019-04-01'
slug: making-sense-of-simulation-models-with-metamodels-part-2-splines-with-arena-and-r
categories:
  - R Blogs
  - R
tags:
  - Arena Simualtion
  - Arena2R
  - Discrete Event Simulation
  - Metamodeling
  - R
header:
  caption: ''
  image: ''
---



<p>In my <a href="post/making-sense-of-models-with-metamodels-low-order-polynomialss-with-arena-and-r/">last post</a>, I used low-order <a href="https://en.wikipedia.org/wiki/Polynomial_regression">polynomial regression</a> to make sense of non-linear simulation model results. In this post, I’ll demonstrate how you can use <a href="https://en.wikipedia.org/wiki/Spline_(mathematics)">splines</a> to summarise results from an <a href="https://www.arenasimulation.com/">Arena</a> simulation model.</p>
<div id="why-splines" class="section level3">
<h3>Why Splines?</h3>
<p>In the <a href="post/making-sense-of-models-with-metamodels-low-order-polynomialss-with-arena-and-r/">previous post</a>, I briefly described the motivation for using metamodels to approximate simulation models results. Splines are among the useful techinques for metamodeling because: (i) they are relatively simple (they are piecewise-defined polynomials); (ii) Unlike low-order polynomials, you can generally use them with a global sampling strategy <span class="citation">[@Barton2006]</span>.</p>
</div>
<div id="data-wrangling" class="section level3">
<h3>Data Wrangling</h3>
<p>Before developing our metamodel, let’s first load the simulation data and do some data wrangling. For the details on this step, please refer to my <a href="post/making-sense-of-models-with-metamodels-low-order-polynomialss-with-arena-and-r/">previous post</a>.</p>
<pre class="r"><code>library(arena2r)</code></pre>
<pre><code>## Warning: package &#39;arena2r&#39; was built under R version 3.5.2</code></pre>
<pre class="r"><code>library(dplyr)</code></pre>
<pre><code>## Warning: package &#39;dplyr&#39; was built under R version 3.5.3</code></pre>
<pre><code>## 
## Attaching package: &#39;dplyr&#39;</code></pre>
<pre><code>## The following objects are masked from &#39;package:stats&#39;:
## 
##     filter, lag</code></pre>
<pre><code>## The following objects are masked from &#39;package:base&#39;:
## 
##     intersect, setdiff, setequal, union</code></pre>
<pre class="r"><code>library(ggplot2)
library(readr)</code></pre>
<pre><code>## Warning: package &#39;readr&#39; was built under R version 3.5.2</code></pre>
<pre class="r"><code>sim_results = arena2r::get_simulation_results(source = &quot;2019-03-metamodeling/&quot;)

sim_results$BatchSize = readr::parse_number(as.character(sim_results$Scenario))

sim_results = subset(sim_results, Statistic == &quot;Entity 1.NumberOut&quot;)

head(sim_results)</code></pre>
<pre><code>##        Scenario          Statistic Replication Value BatchSize
## 51 BatchSize200 Entity 1.NumberOut           1  9200       200
## 52 BatchSize200 Entity 1.NumberOut           2  9368       200
## 53 BatchSize200 Entity 1.NumberOut           3  9322       200
## 54 BatchSize200 Entity 1.NumberOut           4  9039       200
## 55 BatchSize200 Entity 1.NumberOut           5  9255       200
## 56 BatchSize200 Entity 1.NumberOut           6  9400       200</code></pre>
</div>
<div id="trying-splines" class="section level3">
<h3>Trying Splines</h3>
<p>The function bs from the splines package can be used for creating a b-spline term in our regression model.</p>
<pre class="r"><code>## Now using Splines:

library(splines)

# Building a Spline Model:

spline_model &lt;-lm(Value ~ bs(BatchSize),data = sim_results)

summary(spline_model)</code></pre>
<pre><code>## 
## Call:
## lm(formula = Value ~ bs(BatchSize), data = sim_results)
## 
## Residuals:
##      Min       1Q   Median       3Q      Max 
## -221.646  -30.896    1.011   46.969  268.354 
## 
## Coefficients:
##                Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)     9256.49      30.15  306.99  &lt; 2e-16 ***
## bs(BatchSize)1  1312.17     102.27   12.83  &lt; 2e-16 ***
## bs(BatchSize)2  1042.28      88.29   11.80 1.61e-15 ***
## bs(BatchSize)3   961.00      42.95   22.38  &lt; 2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 96.04 on 46 degrees of freedom
## Multiple R-squared:  0.9465, Adjusted R-squared:  0.943 
## F-statistic: 271.1 on 3 and 46 DF,  p-value: &lt; 2.2e-16</code></pre>
<p>Does it make sense?</p>
<pre class="r"><code># Does it make sense ?

ggplot(sim_results, mapping = aes(x = BatchSize, y = Value)) + 
  geom_point() + 
  stat_smooth(method = lm, formula = y ~ splines::bs(x))</code></pre>
<p><img src="/post/2019-04-01-making-sense-of-simulation-models-with-metamodels-part-2-splines-with-arena-and-r_files/figure-html/unnamed-chunk-2-1.png" width="672" /></p>
</div>
<div id="optimizing-with-splines" class="section level3">
<h3>“Optimizing” with Splines</h3>
<p>Now that we found a curve that can approximate our model results, we will use this model to find an “optimal” Batch Size which maximizes our Output Variable.</p>
<pre class="r"><code>## Defining limits:
batchlims &lt;- range(sim_results$BatchSize)

# Generating Test Data
batch.grid&lt;-seq(from=batchlims[1], to = batchlims[2])

# Using the metamodel:
spline_data = data.frame(BatchSize = batch.grid, 
                         Value = predict(spline_model,
                                         newdata = list(BatchSize=batch.grid))
                         )

# What is the Batch Size which &quot;optimizes&quot; the Output?
Optimum_BatchSize &lt;- spline_data$BatchSize[which.max(spline_data$Value)]

Output_Value = spline_data$Value[which.max(spline_data$Value)]</code></pre>
<p>Does it make sense?</p>
<pre class="r"><code># Let&#39;s plot again with the optimum batch size:
ggplot(sim_results, mapping = aes(x = BatchSize, y = Value)) + 
  geom_point() + 
  stat_smooth(method = lm, formula = y ~ splines::bs(x)) +
  geom_vline(xintercept = Optimum_BatchSize) + 
  geom_text(aes(x=Optimum_BatchSize, label=&quot;\nOptimum Batch Size&quot;, y=9700), angle=90, text=element_text(size=11)) + 
  labs(y = &quot;Output&quot;)</code></pre>
<pre><code>## Warning: Ignoring unknown parameters: text</code></pre>
<p><img src="/post/2019-04-01-making-sense-of-simulation-models-with-metamodels-part-2-splines-with-arena-and-r_files/figure-html/unnamed-chunk-4-1.png" width="672" /></p>
<p>In this post, I covered how to apply splines to summarise results from a discrete event simulation model. Splines are a straightforward option to interpolate results from a simulation model, but there are other options out there. Future posts might explore other alternatives such as kriging metamodels and neural nets.</p>
</div>
<div id="references" class="section level1">
<h1>References</h1>
</div>
